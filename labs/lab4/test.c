#include "crisp.h"
#include "kdf_tree_gostr3411_2012_256.h"

uint8_t key[32] = {
    0x83, 0xf6, 0x1e, 0x13, 0xde, 0x22, 0x50, 0x51,
    0x6c, 0x80, 0x53, 0xc3, 0xc2, 0xea, 0x92, 0x63,
    0xf5, 0x1d, 0x17, 0xae, 0xdc, 0x37, 0xd3, 0x7e,
    0x51, 0x54, 0x52, 0xb1, 0xfe, 0xf8, 0x04, 0x32};
uint8_t seed[8] = {0};

uint8_t plaintext[] = {
    0x4c, 0x61, 0x64, 0x69, 0x65, 0x73, 0x20, 0x61, 0x6e, 0x64, 0x20, 0x47, 0x65, 0x6e, 0x74, 0x6c,
    0x65, 0x6d, 0x65, 0x6e, 0x20, 0x6f, 0x66, 0x20, 0x74, 0x68, 0x65, 0x20, 0x63, 0x6c, 0x61, 0x73,
    0x73, 0x20, 0x6f, 0x66, 0x20, 0x27, 0x39, 0x39, 0x3a, 0x20, 0x49, 0x66, 0x20, 0x49, 0x20, 0x63,
    0x6f, 0x75, 0x6c, 0x64, 0x20, 0x6f, 0x66, 0x66, 0x65, 0x72, 0x20, 0x79, 0x6f, 0x75, 0x20, 0x6f,
    0x6e, 0x6c, 0x79, 0x20, 0x6f, 0x6e, 0x65, 0x20, 0x74, 0x69, 0x70, 0x20, 0x66, 0x6f, 0x72, 0x20,
    0x74, 0x68, 0x65, 0x20, 0x66, 0x75, 0x74, 0x75, 0x72, 0x65, 0x2c, 0x20, 0x73, 0x75, 0x6e, 0x73,
    0x63, 0x72, 0x65, 0x65, 0x6e, 0x20, 0x77, 0x6f, 0x75, 0x6c, 0x64, 0x20, 0x62, 0x65, 0x20, 0x69,
    0x74, 0x2e};

void auth_test()
{
    Crisp crisp_out = {0};
    crisp_new(&crisp_out, key, seed);

    uint8_t raw_crisp_message[2048] = {0};
    uint16_t raw_crisp_message_len = 0;
    crisp_encode(&crisp_out, plaintext, sizeof(plaintext) / sizeof(plaintext[0]), raw_crisp_message, &raw_crisp_message_len);

    for (size_t i = 0; i < 10000; i++)
    {
        Crisp crisp_in = {0};
        crisp_new(&crisp_in, key, seed);
        crisp_auth(&crisp_in, raw_crisp_message, raw_crisp_message_len);
        crisp_clear(&crisp_in);
    }
}

void crisp_message_exchange()
{
    uint8_t kdf_label[5] = {0x61, 0x62, 0x6f, 0x62, 0x61};
    uint8_t kdf_seed[] = {0xaf, 0x21, 0x43, 0x41, 0x45, 0x65, 0x63, 0x78};

    Crisp crisp_out = {0};
    crisp_new(&crisp_out, key, seed);
    Crisp crisp_in = {0};
    crisp_new(&crisp_in, key, seed);

    for (size_t i = 0; i < 10000; i++)
    {
        if (i % 100 == 0 && i != 0)
        {
            uint8_t derived_key[32] = {0};
            kdf_tree_gostr3411_2012_256(
                key, 32 * 8,
                kdf_label, sizeof(kdf_label) / sizeof(kdf_label[0]),
                kdf_seed, sizeof(kdf_seed) / sizeof(kdf_seed[0]),
                1,
                derived_key, 32 * 8);
            memcpy(key, derived_key, 32);

            crisp_clear(&crisp_in);
            crisp_clear(&crisp_out);
            crisp_new(&crisp_in, key, seed);
            crisp_new(&crisp_out, key, seed);
        }

        uint8_t raw_crisp_message[2048] = {0};
        uint16_t raw_crisp_message_len = 0;
        CrispMessage cm = {0};

        crisp_encode(&crisp_out, plaintext, sizeof(plaintext) / sizeof(plaintext[0]), raw_crisp_message, &raw_crisp_message_len);
        crisp_decode(&crisp_in, raw_crisp_message, raw_crisp_message_len, &cm);
    }
    crisp_clear(&crisp_in);
    crisp_clear(&crisp_out);
}

void run_test_suite()
{
    // auth_test();
    crisp_message_exchange();
}

int main()
{
    run_test_suite();
    return 0;
}